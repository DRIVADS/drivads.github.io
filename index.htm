
<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head><script src="https://getbootstrap.com/docs/5.3/assets/js/color-modes.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="DRIVADS">
    <title>SMMA</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/sidebars/">

    

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">

<link href="https://getbootstrap.com/docs/5.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Favicons -->
<link rel="apple-touch-icon" href="imgs/Captura.png" sizes="180x180">
<link rel="icon" href="imgs/Captura.png" sizes="32x32" type="image/png">
<link rel="icon" href="imgs/Captura.png" sizes="16x16" type="image/png">
<link rel="mask-icon" href="https://getbootstrap.com/docs/5.3/assets/img/favicons/safari-pinned-tab.svg" color="#712cf9">
<link rel="icon" href="imgs/CapturaIcono.ico">
<meta name="theme-color" content="#712cf9">


    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        width: 100%;
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .btn-bd-primary {
        --bd-violet-bg: #712cf9;
        --bd-violet-rgb: 112.520718, 44.062154, 249.437846;

        --bs-btn-font-weight: 600;
        --bs-btn-color: var(--bs-white);
        --bs-btn-bg: var(--bd-violet-bg);
        --bs-btn-border-color: var(--bd-violet-bg);
        --bs-btn-hover-color: var(--bs-white);
        --bs-btn-hover-bg: #6528e0;
        --bs-btn-hover-border-color: #6528e0;
        --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
        --bs-btn-active-color: var(--bs-btn-hover-color);
        --bs-btn-active-bg: #5a23c8;
        --bs-btn-active-border-color: #5a23c8;
      }

      .bd-mode-toggle {
        z-index: 1500;
      }

      .bd-mode-toggle .dropdown-menu .active .bi {
        display: block !important;
      }
	
	  body, html {
		margin: 0;
		padding: 0;
	  }

	  .full-width-container {
		width: 100vw;
		padding: 10px;
	  }

	  #monitoreo-scroll {
		max-height: auto; /* O ajusta al % que quieras del alto de pantalla */
	  }

	  #resultados-scroll {
		max-height: 30vh;
		overflow-y: auto;
	  }
		
	  .main-scrollable {
		  width: 100vw;
		  position: relative;
		  overflow-y: auto;
		}
	 
	  .no-scroll {
		  overflow: hidden;
		}
    </style>

    
    <!-- Custom styles for this template -->
    <link href="https://getbootstrap.com/docs/5.3/examples/sidebars/sidebars.css" rel="stylesheet">
  </head>
  <body>
	  <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
      <symbol id="check2" viewBox="0 0 16 16">
        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
      </symbol>
      <symbol id="circle-half" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
      </symbol>
      <symbol id="moon-stars-fill" viewBox="0 0 16 16">
        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
      </symbol>
      <symbol id="sun-fill" viewBox="0 0 16 16">
        <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
      </symbol>
    </svg>
    <div class="dropdown position-fixed bottom-0 end-0 mb-3 me-3 bd-mode-toggle">
      <button class="btn btn-bd-primary py-2 dropdown-toggle d-flex align-items-center"
              id="bd-theme"
              type="button"
              aria-expanded="false"
              data-bs-toggle="dropdown"
              aria-label="Toggle theme (auto)">
        <svg class="bi my-1 theme-icon-active" width="1em" height="1em"><use href="#circle-half"></use></svg>
        <span class="visually-hidden" id="bd-theme-text">Toggle theme</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="bd-theme-text">
        <li>
          <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
            <svg class="bi me-2 opacity-50" width="1em" height="1em"><use href="#sun-fill"></use></svg>
            Light
            <svg class="bi ms-auto d-none" width="1em" height="1em"><use href="#check2"></use></svg>
          </button>
        </li>
        <li>
          <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
            <svg class="bi me-2 opacity-50" width="1em" height="1em"><use href="#moon-stars-fill"></use></svg>
            Dark
            <svg class="bi ms-auto d-none" width="1em" height="1em"><use href="#check2"></use></svg>
          </button>
        </li>
        <li>
          <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
            <svg class="bi me-2 opacity-50" width="1em" height="1em"><use href="#circle-half"></use></svg>
            Auto
            <svg class="bi ms-auto d-none" width="1em" height="1em"><use href="#check2"></use></svg>
          </button>
        </li>
      </ul>
    </div>
	  
<main class="d-flex flex-nowrap">
  <h1 class="visually-hidden">SMMA</h1>

  <div class="d-flex flex-column flex-shrink-0 p-3 text-bg-dark" style="width: 280px;">
    <a href="../../Downloads/Captura.png" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
      <img src="imgs/CapturaFondo.png" alt="logo" width="50" height="42">
      <span class="fs-4">SMMA</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a href="php/Administrador/NodosIoT.htm" class="nav-link text-white" aria-current="page">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi pe-none me-2" viewBox="0 0 16 16">
			  <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"/>
		  </svg>
          Inicio
        </a>
      </li>
	  <li>
        <a href="#" class="nav-link active">
		  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi pe-none me-2" viewBox="0 0 16 16">
		  <path d="M8 1a.5.5 0 0 1 .5.5v5.243L9 7.1V4.72C9 3.77 9.77 3 10.72 3c.524 0 1.023.27 1.443.592.431.332.847.773 1.216 1.229.736.908 1.347 1.946 1.58 2.48.176.405.393 1.16.556 2.011.165.857.283 1.857.24 2.759-.04.867-.232 1.79-.837 2.33-.67.6-1.622.556-2.741-.004l-1.795-.897A2.5 2.5 0 0 1 9 11.264V8.329l-1-.715-1 .715V7.214c-.1 0-.202.03-.29.093l-2.5 1.786a.5.5 0 1 0 .58.814L7 8.329v2.935A2.5 2.5 0 0 1 5.618 13.5l-1.795.897c-1.12.56-2.07.603-2.741.004-.605-.54-.798-1.463-.838-2.33-.042-.902.076-1.902.24-2.759.164-.852.38-1.606.558-2.012.232-.533.843-1.571 1.579-2.479.37-.456.785-.897 1.216-1.229C4.257 3.27 4.756 3 5.28 3 6.23 3 7 3.77 7 4.72V7.1l.5-.357V1.5A.5.5 0 0 1 8 1m3.21 8.907a.5.5 0 1 0 .58-.814l-2.5-1.786A.5.5 0 0 0 9 7.214V8.33z"/>
		</svg>
          Monitoreo
        </a>
      </li>
      <li>
        <a href="php/Metricas.htm" class="nav-link text-white">
		  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi pe-none me-2" viewBox="0 0 16 16">
		  <path fill-rule="evenodd" d="M6 1h6v7a.5.5 0 0 1-.757.429L9 7.083 6.757 8.43A.5.5 0 0 1 6 8z"/>
		  <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2"/>
		  <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z"/>
		</svg>
          Historial
        </a>
      </li>
      <li>
        <a href="php/Contacto.htm" class="nav-link text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi pe-none me-2" viewBox="0 0 16 16">
			  <path d="M10.5 8.5V3.707l.854-.853A.5.5 0 0 0 11.5 2.5v-2A.5.5 0 0 0 11 0H9.5a.5.5 0 0 0-.5.5v8zM5 7c0 .334-.164.264-.415.157C4.42 7.087 4.218 7 4 7s-.42.086-.585.157C3.164 7.264 3 7.334 3 7a1 1 0 0 1 2 0"/>
			  <path d="M4 3h4v1H6.646A4 4 0 0 1 8 7v6h7V7a3 3 0 0 0-3-3V3a4 4 0 0 1 4 4v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V7a4 4 0 0 1 4-4m0 1a3 3 0 0 0-3 3v6h6V7a3 3 0 0 0-3-3"/>
		  </svg>
          Contacto
        </a>
      </li>
	  <li>
        <a href="php/nosotros.htm" class="nav-link text-white">
			  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi pe-none me-2" viewBox="0 0 16 16">
			  <path d="M9 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0m-9 8c0 1 1 1 1 1h10s1 0 1-1-1-4-6-4-6 3-6 4m13.5-8.09c1.387-1.425 4.855 1.07 0 4.277-4.854-3.207-1.387-5.702 0-4.276Z"/>
			</svg>
          Acerca de nosotros
        </a>
      </li>
    </ul>
    <hr>
    <div class="dropdown">
      <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        <img src="imgs/user.jpg" alt="" width="32" height="32" class="rounded-circle me-2">
        <strong>Cuvalles</strong>
      </a>
      <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
        <li><a class="dropdown-item" href="#">Opciones x</a></li>
        <li><a class="dropdown-item" href="#">Ajustes</a></li>
        <li><a class="dropdown-item" href="#">Perfil</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="php/login.html">Cerrar Cesión</a></li>
      </ul>
    </div>
  </div>

  <div class="b-example-divider b-example-vr"></div>
	
  <main id="main-content" class="d-flex flex-nowrap main-scrollable">
  
  <!--<div class="col-sm-6 col-lg-12 m-2 row" style="max-height: 600px; overflow-y: auto;">-->
  <div class="full-width-container">
  <div class="row g-3">
  <!-- Buscador + Resultados -->
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <form class="needs-validation" novalidate id="filtro-form">
              <div class="row">
				  
				<div class="col-sm-6 col-lg-3">
				  <label for="pais" class="form-label">País</label>
				  <select class="form-select" id="pais" required>
					<option value="">Seleccionar...</option>
				  </select>
				  <div class="invalid-feedback">Selecciona un País.</div>
				</div>
				  
                <div class="col-sm-6 col-lg-3">
                  <label for="estado" class="form-label">Estado</label>
                  <select class="form-select" id="estado" required>
                    <option value="">Seleccionar...</option>
                  </select>
                  <div class="invalid-feedback">Por favor selecciona un Estado.</div>
                </div>
				  
                <div class="col-sm-6 col-lg-3">
                  <label for="municipio" class="form-label">Municipio</label>
                  <select class="form-select" id="municipio" required>
                    <option value="">Seleccionar...</option>
                  </select>
                  <div class="invalid-feedback">Selecciona un Municipio.</div>
                </div>
				  
                <div class="col-sm-6 col-lg-3">
                  <label for="localidad" class="form-label">Localidad</label>
                  <select class="form-select" id="localidad" required>
                    <option value="">Seleccionar...</option>
                  </select>
                  <div class="invalid-feedback">Selecciona una Localidad.</div>
                </div>
				  
                <div class="col-sm-6 col-lg-3">
                  <button class="btn btn-primary w-100 mt-3" type="submit">Buscar</button>
                </div>
              </div>
            </form>

            <hr>
			<!-- aqui empieza lo de los nodos-->

            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Resultados</h5>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResultadosContent">
                Mostrar / Ocultar
              </button>
            </div>

            <div id="collapseResultadosContent" class="collapse show mt-2">
              <div id="resultados-scroll">
                <ul class="list-group" id="resultado-lista">
                  <li class="list-group-item">Usa los filtros para ver los nodos.</li>
                </ul>
              </div>
            </div>
			 <!--imgs/Captura.png-->
			<hr>
		
		<!-- aqui empieza lo de los sensores-->
			  
		  <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Sensores del Nodo</h5>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSensores">
                Mostrar / Ocultar
              </button>
            </div>

            <div id="collapseSensores" class="collapse show mt-2">
              <div id="sensores-scroll">
                <div class="row" id="sensores-contenedor">
                  <!-- Tarjetas de sensores -->
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Monitoreo + Sensores -->
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0" id="monitoreo-titulo">Monitoreo</h5>
            </div>

            <div id="monitoreo-scroll" class="mt-2">
              <div class="row" id="monitoreo-contenedor">
                <!-- Tarjetas de monitoreo -->
              </div>
            </div>
            <hr>          
          </div>
        </div>
      </div>
    </div>
  </div>
	 <!-- Indicador de carga local -->
	<div id="cargando-main" style="
	  position: absolute;
	  top: 0; left: 0;
	  width: 100%;
	  height: 100%;
	  background-color: rgba(255, 255, 255, 0.7);
	  z-index: 50;
	  display: none;
	  justify-content: center;
	  align-items: center;
	">
	  <div class="text-center">
		<div class="spinner-border text-primary" role="status"></div>
		<div class="mt-2 fw-bold text-primary">Cargando datos...</div>
	  </div>
	</div>
</main>

<!-- Modal para mapa -->
<div class="modal fade" id="modalMapa" tabindex="-1" aria-labelledby="modalMapaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalMapaLabel">Ubicación del Nodo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <iframe id="iframeMapa" width="100%" height="450" style="border:0;" allowfullscreen="" loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>
</div>




<script>
  const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
  const apiBase = `${proxyUrl}https://smma-aobk.onrender.com`;

  const selectPais = document.getElementById('pais');
  const selectEstado = document.getElementById('estado');
  const selectMunicipio = document.getElementById('municipio');
  const selectLocalidad = document.getElementById('localidad');
  const form = document.getElementById('filtro-form');
  const alertContainer = document.getElementById('alertContainer');
  const resultadoLista = document.getElementById('resultado-lista');
  const monitoreoContenedor = document.getElementById('monitoreo-contenedor');
  const sensoresContenedor = document.getElementById('sensores-contenedor');
  const tituloMonitoreo = document.getElementById('monitoreo-titulo');

  let zonasDisponibles = [];

  function mostrarCargaMain() {
	  document.getElementById('cargando-main').style.display = 'flex';
	  document.getElementById('main-content').classList.add('no-scroll'); // desactiva scroll en main
	}

	function ocultarCargaMain() {
	  document.getElementById('cargando-main').style.display = 'none';
	  document.getElementById('main-content').classList.remove('no-scroll'); // reactiva scroll en main
	}

  function deshabilitarSelects() {
    selectPais.disabled = true;
    selectEstado.disabled = true;
    selectMunicipio.disabled = true;
    selectLocalidad.disabled = true;
  }

  function habilitarSelects() {
    selectPais.disabled = false;
    selectEstado.disabled = false;
    selectMunicipio.disabled = false;
    selectLocalidad.disabled = false;
  }

  function llenarSelect(select, items) {
    select.innerHTML = '<option value="">Seleccionar...</option>';
    [...new Set(items)].forEach(item => {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      select.appendChild(option);
    });
  }

  function abrirMapa(coordenadas) {
    if (!coordenadas || !coordenadas.includes(',')) {
      alert('Coordenadas inválidas');
      return;
    }

    const [lat, lng] = coordenadas.split(',').map(c => c.trim());

    if (isNaN(lat) || isNaN(lng)) {
      alert('Coordenadas inválidas');
      return;
    }

    const src = `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
    document.getElementById('iframeMapa').src = src;

    const modal = new bootstrap.Modal(document.getElementById('modalMapa'));
    modal.show();
  }

  function mostrarAlerta(mensaje, tipo = 'info') {
    const alertId = `alert-${Date.now()}`;
    const alertHTML = `
      <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show" role="alert">
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>`;
    alertContainer.insertAdjacentHTML('beforeend', alertHTML);
    setTimeout(() => {
      const alertEl = document.getElementById(alertId);
      if (alertEl) alertEl.remove();
    }, 4000);
  }

  async function obtenerZonas() {
    mostrarCargaMain();
    deshabilitarSelects();
    try {
      const res = await fetch(`${apiBase}/api/zonas`);
      if (!res.ok) throw new Error('Error al obtener zonas');
      zonasDisponibles = await res.json();
      const paises = zonasDisponibles.map(z => z.pais);
      llenarSelect(selectPais, paises);
    } catch (error) {
      mostrarAlerta('Error al cargar zonas.', 'danger');
      console.error(error);
    } finally {
      habilitarSelects();
      ocultarCargaMain();
    }
  }

  async function obtenerDatos(filtro = {}) {
    mostrarCargaMain();
    try {
      const res = await fetch(`${apiBase}/api/nodos`);
      if (!res.ok) throw new Error('Error al obtener nodos');
      const nodos = await res.json();

      const mapaZonas = new Map(zonasDisponibles.map(z => [z.id_zona || z._id, z]));

      const nodosFiltrados = nodos.filter(nodo => {
        const zona = mapaZonas.get(nodo.id_zona) || {};
        return (!filtro.pais || zona.pais === filtro.pais) &&
               (!filtro.estado || zona.estado === filtro.estado) &&
               (!filtro.municipio || zona.municipio === filtro.municipio) &&
               (!filtro.localidad || zona.localidad === filtro.localidad);
      });

      resultadoLista.innerHTML = '';
      monitoreoContenedor.innerHTML = '';
      sensoresContenedor.innerHTML = '';
      tituloMonitoreo.textContent = 'Monitoreo';

      if (nodosFiltrados.length === 0) {
        resultadoLista.innerHTML = '<li class="list-group-item">No se encontraron nodos con esos filtros.</li>';
        return;
      }

      nodosFiltrados.forEach(nodo => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.style.cursor = 'pointer';
        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <span>${nodo.nombre}</span>
            ${nodo.cordenadas ? `
              <button class="btn btn-outline-primary btn-sm ms-2" onclick="abrirMapa('${nodo.cordenadas}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-globe-americas" viewBox="0 0 16 16">
                  <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0..."/>
                </svg>
              </button>` : '<span class="text-muted small ms-2">(Sin coordenadas)</span>'}
          </div>`;
        li.addEventListener('click', () => {
          tituloMonitoreo.textContent = `Monitoreo - ${nodo.nombre}`;
          mostrarMonitoreoNodo(nodo.id_nodo);
          renderizarSensores(nodo.sensores || []);
        });
        resultadoLista.appendChild(li);
      });
    } catch (error) {
      mostrarAlerta('Error al obtener nodos.', 'danger');
      console.error(error);
    } finally {
      ocultarCargaMain();
    }
  }

  function obtenerGifPorTipo(tipo) {
    const tipoNormalizado = tipo.toLowerCase();
    switch (tipoNormalizado) {
      case 'temperatura': return 'imgs/particulas.gif';
      case 'uv': return 'imgs/radiacion-uv.gif';
      case 'humedad': return 'imgs/lluvia.gif';
      case 'angulo': return 'imgs/veleta.gif';
      case 'velocidad': return 'imgs/viento.gif';
      case 'co2': return 'imgs/co2.gif';
      case 'litros': return 'https://media.giphy.com/media/3o7TKsQmoCf6Q/giphy.gif';
      default: return 'imgs/particulas.gif';
    }
  }

  async function mostrarMonitoreoNodo(id_nodo) {
    mostrarCargaMain();
    try {
      const res = await fetch(`${apiBase}/api/monitoreos`);
      if (!res.ok) throw new Error('Error al obtener monitoreos');
      const monitoreos = await res.json();

      const monitoreosNodo = monitoreos.filter(m => m.id_nodo === id_nodo);

      if (monitoreosNodo.length === 0) {
        monitoreoContenedor.innerHTML = `<div class="col-12"><div class="alert alert-warning">El nodo no tiene monitoreo registrado.</div></div>`;
        return;
      }

      const monitoreoReciente = monitoreosNodo.reduce((a, b) => {
        const fechaA = new Date(`${a.fecha}T${a.hora}`);
        const fechaB = new Date(`${b.fecha}T${b.hora}`);
        return fechaA > fechaB ? a : b;
      });

      monitoreoContenedor.innerHTML = '';
      monitoreoReciente.Datos.forEach(dato => {
        const gifURL = obtenerGifPorTipo(dato.tipo);
        const card = `
          <div class="col-sm-6 col-lg-4 mb-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <img src="${gifURL}" alt="${dato.tipo}" style="height: 30px;">
                  <h5 class="card-title text-capitalize mb-0">${dato.tipo}</h5>
                </div>
                <p class="card-text">${dato.valor}</p>
                <p class="card-text"><small class="text-body-secondary">Última actualización ${monitoreoReciente.hora} - ${monitoreoReciente.fecha}</small></p>
              </div>
            </div>
          </div>`;
        monitoreoContenedor.insertAdjacentHTML('beforeend', card);
      });
    } catch (error) {
      mostrarAlerta('Error al obtener monitoreo.', 'danger');
      console.error(error);
    } finally {
      ocultarCargaMain();
    }
  }

  function renderizarSensores(sensores) {
    sensoresContenedor.innerHTML = '';
    sensores.forEach(sensor => {
      const div = document.createElement('div');
      div.className = 'col-sm-6 col-lg-4 mb-3';
      div.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">${sensor.nombre}</h6>
            <p class="card-text">Tipo: ${sensor.tipo_dato}</p>
            <p class="card-text">Modo: ${sensor.analogico_digital}</p>
          </div>
        </div>`;
      sensoresContenedor.appendChild(div);
    });
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    obtenerDatos({
      pais: selectPais.value || null,
      estado: selectEstado.value || null,
      municipio: selectMunicipio.value || null,
      localidad: selectLocalidad.value || null
    });
  });

  selectEstado.addEventListener('change', () => {
    const municipios = zonasDisponibles
      .filter(z => z.pais === selectPais.value && z.estado === selectEstado.value)
      .map(z => z.municipio);
    llenarSelect(selectMunicipio, municipios);
    selectLocalidad.innerHTML = '<option value="">Seleccionar...</option>';
  });

  selectMunicipio.addEventListener('change', () => {
    const localidades = zonasDisponibles
      .filter(z =>
        z.pais === selectPais.value &&
        z.estado === selectEstado.value &&
        z.municipio === selectMunicipio.value
      )
      .map(z => z.localidad);
    llenarSelect(selectLocalidad, localidades);
  });

  selectPais.addEventListener('change', () => {
    const estados = zonasDisponibles
      .filter(z => z.pais === selectPais.value)
      .map(z => z.estado);
    llenarSelect(selectEstado, estados);
    selectMunicipio.innerHTML = '<option value="">Seleccionar...</option>';
    selectLocalidad.innerHTML = '<option value="">Seleccionar...</option>';
  });

  obtenerZonas().then(obtenerDatos);
</script>


							
</main>
<script src="https://getbootstrap.com/docs/5.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://getbootstrap.com/docs/5.3/examples/sidebars/sidebars.js"></script>
</body>
</html>